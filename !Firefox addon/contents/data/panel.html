<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <title>Tumblr Image Sorter</title>
    <link rel="stylesheet" media="screen" href="panel.css"> 
	<link rel="stylesheet" media="screen" href="./spectrum/spectrum.css"> 
    <link rel="stylesheet" media="screen" href="./jquery-ui/jquery-ui.css">  
  </head>
  <body>
  <script src="jquery.js"></script>
  <script src="./jquery-ui/jquery-ui.js"></script>
  <script src="./spectrum/spectrum.js"></script>
    <div id="title">
      <img style="float:left;" src="icon-64.png" id="icon">
      <h1 style="line-height:32px;height:32px;margin-top:16px;">Tumblr Image Sorter</h1><div id="version">v1.2</div>
    </div>
 
    <div id="content">
		<div id="tabs">
		  <ul>
			<li><a href="#lists">Lists</a></li>
			<li><a href="#options">Options</a></li>
			<li><a href="#about">About</a></li>
		  </ul>
		  <div id="lists">
		  
			<div id="accordion">
			
			<h3>ignore</h3>
			  <div>				
				<p>List of ignored tags, separated by commas</p>
				<input type="text", id="ignore"  />
			  </div>	
			  
			<h3>folders</h3>
			  <div>				
			    
				<p>Root collection folder</p>
				<p><input type="text" id="root" placeholder="F:\ull\path\required\" value=''/></p>
				<p>Metasymbol: <input type="text" id="ms" value="!" maxlength=1 size=1 style="width:20px; text-align:center;"/> indicates a subcategory folder</p><br>
				<p>
				List of tags matched with folders relative to root
				</p> <center>
				<table id="folders" class="taglist">	<thead><tr><th>tag</th>	<th></th>	<th>folder</th></tr></thead>
					<tbody>
						<tr><td><input type="text"  class="tag group" value="group" readonly disabled/></td>	<td class='btn'></td>	<td><input type="text"  class="folder group" placeholder="required" value="!group"/></td></tr>
						<tr><td><input type="text"  class="tag solo" value="solo" readonly disabled/></td>	<td class='btn'></td>	<td><input type="text"  class="folder solo" placeholder="required" value="!solo"/></td></tr>
						<tr><td><input type="text"  class="tag unsorted" value="unsorted" readonly disabled/></td><td class='btn'></td>	<td><input type="text"   class="folder unsorted" placeholder="required" value="!unsorted"/></td></tr>
					</tbody>
					<tfoot>
						<tr><td><input type="text" class="tag"/></td>	<td class='btn'><input type="button" value="+" class="addrow"/></td>	<td><input type="text" class="folder"/></td></tr>
					</tfoot>

				</table>
				</center>
				<p><br><table id="port"><tr>
					<td><input type='button'  class="im" name="folders" value="import..."></td><td><input type='button'  class="ex" name="folders" value="export..."></td>
					</tr>
				</table></p>
				<input type="file" id="file" accept=".json*.txt" hidden/>
			  </div>
			  
			<h3>names & meta</h3>
			    <div><center>			
					<p>List of name tags by category matched with translations</p><br>					
					<table id="names" class="taglist">	<thead><tr><th>tag</th>	<th></th>	<th>translation</th></tr></thead>
						<tbody>
						</tbody>
						<tfoot>
							<tr><td><input type="text" class="tag name"/></td>	<td class='btn'><input type="button" value="+" class="addrow"/></td>	<td><input type="text" class="translation"/></td></tr>
						</tfoot> 
					</table><br>
					<p>List of meta tags by category matched with translations</p><br>
					<center>
					<table id="meta" class="taglist">	<thead><tr><th>tag</th>	<th></th>	<th>translation</th></tr></thead>
						<tbody>
						</tbody>
						<tfoot>
							<tr><td><input type="text" class="tag meta"/></td>	<td class='btn'><input type="button" value="+" class="addrow"/></td>	<td><input type="text" class="translation"/></td></tr>
						</tfoot>
						</tbody>
					</table>
					</center>
					<p><br><table id="port"><tr>
						<td><input type='button' class="im" name="names & meta" value="import..."></td><td><input type='button' class="ex" name="names & meta" value="export..."></td>
						</tr>
					</table></p> 
			    </div>
			  
			</div>
		  </div>
		  
		  <div id="options">			   
			 <fieldset> 
			  <legend>Post page settings</legend><p>
				<input type="color"  id="highlightColor" value="black">				
				<label for="highlightColor">Outline color for saved images in posts</label>
				</p><br><p>
				<input type="checkbox"  id="enableOnDashboard" checked>				
				<label for="enableOnDashboard">Enable on /dashboard and /tagged/</label>
				</p><br><p>
				<input type="checkbox"  id="linkify" checked>				
				<label for="linkify">Linkify inline images</label><p >
				<small>Enables processing of images found in any posts, not only photo ones. Inline images are linked to either their HD version (if available), or their reverse Google image search.</small></p>
				</p>
			 </fieldset>  
			 <br>
			 <fieldset> 
			  <legend>Image page settings</legend> <p>
				<input type="checkbox"  id="allowUnicode" >				
				<label for="allowUnicode">Allow Unicode characters in manual translation input</label><p >
				<small>The goal of the addon is to produce filenames with highest compatibility, converting all input to ANSI. But you can enable it to accept Unicode characters as well (not tested).</small></p>
				</p><br><p>
				<input type="checkbox"  id="useFolderNames" checked>				
				<label for="useFolderNames">Use folder names as tags</label><p >
				<small>Automatically expand &lt;folders&gt; database to recognize folder names as tags. This way you won't have to input both original and translated versions of a tag if you match original tag with translated folder name.</small></p>
				</p>
			 </fieldset> 
		  </div>
		  
		  <div id="about">
			<fieldset>
			<legend>About</legend><p>
			  <b>Tumblr Image Sorter</b> is a free browser extension created by Seedmanc to save time spent on choosing the correct save destination and file name for images from Tumblr.</p><br>
			  <p>You can find the source code and a thorough Readme in English & Russian at the project page: <u><a href="http://github.com/Seedmanc/Tumblr-image-sorter">http://github.com/Seedmanc/Tumblr-image-sorter</a></u>.
			  </p>
			  </fieldset>			  
		  </div>
		</div>
    </div>
	   
	<div id="dialog" title="error"><span class="ui-icon ui-icon-alert"></span><div>text</div></div>
	<div id="confirm" title="select action"><span class="ui-icon ui-icon-help"></span><div>Would you like to add or replace data?</div></div>

<script>
	$("#tabs").tabs();
	$("#accordion").accordion({
		heightStyle: "content",
		collapsible: true
  });
	$('input.addrow').on('click',  addRow);
	$('input.im').on('click', imprt);
	$('input.ex').on('click', exprt);	
	$('input#ignore').on('change', function(e){
		input=e.target.value;
		e.target.value=$.map(input.split(','), function(v){
			trimmed=v.trim();
			return (trimmed!='')?v.trim():undefined;
		}).join(',');
	});
	$("#highlightColor").spectrum({
		color: "#000",
		change: function(color) {alert(color.toHexString());
    }
});
	var exclrgxp=new RegExp(/\/|:|\||>|<|\?|"|\*/g);
	var merge=false;
	
	function checkTag(e){
		$(e.target).css('background-color', '');
		if (e.target.value.indexOf(',')!=-1) {
			$(e.target).css('background-color', '#FFBF80');
			e.target.value=e.target.value.replace(',',' ');
		};		
		e.target.value=e.target.value.toLowerCase().trim();
		if (!e.target.value)
			$(e.target).css('background-color', '#FF8080');
	};
	
	function checkMatch(e){
		$(e.target).css('background-color', '');
		if (exclrgxp.test(e.target.value)) {
			$(e.target).css('background-color', '#FFBF80');
			e.target.value=e.target.value.replace(exclrgxp,'-');
		};		
		e.target.value=e.target.value.trim();		
		if (!e.target.value)
			$(e.target).css('background-color', '#FF8080');
	};
	
	$('input.tag').on('change', checkTag);	
	$('input.folder').on('change', checkMatch);
	$('input.translation').on('change', checkMatch);

	$('input#ms').on('change', function(e){
		$(e.target).css('background-color', '');
		msexclrgxp=new RegExp(exclrgxp.source+"|\\s|\\\\",'g');
		if (msexclrgxp.test(e.target.value)) {
			e.target.value=e.target.value.replace(msexclrgxp,'!');
			$(e.target).css('background-color', '#FFBF80');
		};			
	});	
	$('input#root').on('change', function(e){
		if (e.target.value[e.target.value.length-1]!='\\')
			e.target.value+='\\';
		rootrgxp=/^([a-z]:){1}(\\[^<>:"/\\|?*]+)+\\$/gi;
		$(e.target).css('background-color', ''); 
		if (!rootrgxp.test(e.target.value)) {
			e.target.focus();											//no idea how to replace wrong characters here
			$(e.target).css('background-color', '#FF8080');
		};			
	});		
	function addRow(t){
		var oldrow=$(t.target).parents('tr:first');
		var newrow=oldrow.clone();
		newrow.find('input:text').filter(function(){return this.value.trim() === "";}).css('background-color', '#FF8080');
		newrow.find('input.addrow').attr('value', '-').attr('class','remrow').on('click', remRow);
		newrow.find('input.tag').on('change', checkTag);
		newrow.find('input:text:last').on('change', checkMatch);
		oldrow.find("input:text").prop('value', '').css('background-color','');
		var whereto=oldrow.parents('table').find('tbody');
		if (whereto.find('tr:last').length)
			whereto.find('tr:last').after(newrow)
		else
			whereto.append(newrow);
	};
	function remRow(t){
		var row=$(t.target).parents('tr:first');
		row.remove();
	};
	
	function collectFolderData(){
		var obj={root:'', metasymbol:'', folders:{ }};
		obj.root=$('input#root').prop('value');
		obj.metasymbol=$('input#ms').prop('value');
		var tbl = $('table#folders tbody tr').get().map(function(row) {
			return $(row).find('td').not('.btn').get().map(function(cell) {
				return $(cell).find('input:text').prop('value');
			});
		});  
		$.each(tbl, function(i,row){
			obj.folders[row[0]]=row[1];
		});
		return obj;
	};
	function collectNaMeData(){
		var obj={names:{ }, meta:{ }};
		var names = $('table#names tbody tr').get().map(function(row) {
			return $(row).find('td').not('.btn').get().map(function(cell) {
				return $(cell).find('input:text').prop('value');
			});
		});  
		var meta = $('table#meta tbody tr').get().map(function(row) {
			return $(row).find('td').not('.btn').get().map(function(cell) {
				return $(cell).find('input:text').prop('value');
			});
		}); 
		$.each(names, function(i,row){
			obj.names[row[0]]=row[1].replace('\\','-');
		});
		$.each(meta, function(i,row){
			obj.meta[row[0]]=row[1].replace('\\','-');
		});
		return obj;
	};
	function exprt(e){
		var source=$(e.target).prop('name');
		var obj=(source=='folders')?collectFolderData():collectNaMeData();		
		var data="text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(obj,null,'\t'));
		$('<a href="data:'+data+'" download="'+source+'.json.txt">&nbsp;</a>')[0].click();
	};
	
	function imprt(e){ 		
		var source=$(e.target).prop('name');
		$('input#file')[0].onchange=function(evt){
			var file = evt.target.files[0];
			
			if (file.type!='text/plain') {
				$('#dialog div').text('Wrong filetype: must be text/json');
				$("#dialog").dialog("open"); 
				return false;
			};
			
			var obj=(source=='folders')?collectFolderData():collectNaMeData();
			
			var reader = new FileReader();
			reader.onloadend = function(e) {
			  try {	
					o=JSON.parse(e.target.result);
			  } catch(err){
					$('#dialog div').text('Error: '+err.message);
					$("#dialog").dialog("open"); 
				return false;
			  };
			   if (source=='folders'){
				if (o.root) {
					if (merge && obj.root) {}
					else 
						obj.root=o.root;
				}
				else {
					$('#dialog div').text('No root entry found');
					$("#dialog").dialog("open");
				};
					
				if (o.metasymbol) {
					if (merge && obj.metasymbol) {}
					else 
						obj.metasymbol=o.metasymbol;
				}
				else {
					$('#dialog div').text('No metasymbol entry found');
					$("#dialog").dialog("open");
				};	
					
				if (o.folders) {
					if (!merge) 
						obj.folders={};
					$('table#folders input.remrow').each(function(i,v){v.click();});

					$.each(Object.keys(o.folders), function(i,v){
						if (!obj.folders[v])
							obj.folders[v]=o.folders[v];
					});
				}
				else {
					$('#dialog div').text('No folders entry found');
					$("#dialog").dialog("open");
				};				
				assignFolderData(obj);
				
			   } else {
				if (o.names) {
					if (!merge) 
						obj.names={};
					$('table#names input.remrow').each(function(i,v){v.click();});

					$.each(Object.keys(o.names), function(i,v){
						if (!obj.names[v])
							obj.names[v]=o.names[v];
					});
				}
				else{
					$('#dialog div').text('No names entry found');
					$("#dialog").dialog("open");
				};
				if (o.meta) {
					if (!merge) 
						obj.meta={};
					$('table#meta input.remrow').each(function(i,v){v.click();});

					$.each(Object.keys(o.meta), function(i,v){
						if (!obj.meta[v])
							obj.meta[v]=o.meta[v];
					});
				}
				else{
					$('#dialog div').text('No meta entry found');
					$("#dialog").dialog("open");
				};
				assignNaMeData(obj);
			  };
			};
			reader.readAsText(file);			
		};
		$('#confirm').dialog('open');
	};
	
	function assignFolderData(obj){
		$('input#root').prop('value',obj.root).change();
		$('input#ms').prop('value',obj.metasymbol).change();	
		newrow=$('table#folders input.addrow').parents('tr:first');
		$.each(Object.keys(obj.folders), function(i,v){
			if (['group','solo','unsorted'].indexOf(v)!=-1){
				$('input.'+v).filter('.folder').prop('value',obj.folders[v]);
				return true;
			};
			newrow.find('input:first').prop('value',v).change();
			newrow.find('input:last').prop('value',obj.folders[v]).change();
			newrow.find('input.addrow')[0].click();
		}); 
	};
	
	function assignNaMeData(obj){ 
		newrow=$('table#names input.addrow').parents('tr:first');
		$.each(Object.keys(obj.names), function(i,v){ 
			newrow.find('input:first').prop('value',v).change();
			newrow.find('input:last').prop('value',obj.names[v]).change();
			newrow.find('input.addrow')[0].click();
		}); 
		
		newrow=$('table#meta input.addrow').parents('tr:first');
		$.each(Object.keys(obj.meta), function(i,v){ 
			newrow.find('input:first').prop('value',v).change();
			newrow.find('input:last').prop('value',obj.meta[v]).change();
			newrow.find('input.addrow')[0].click();
		});
	};
	
	$( "#dialog" ).dialog({
		dialogClass:'alert',
		autoOpen: false,
		modal:true,
		buttons: {
			Ok: function() {
				$( this ).dialog( "close" );
			}
		}
	});
	
	$( "#confirm" ).dialog({
		dialogClass:'no-close',
		autoOpen: false,
		modal: 	true,
		 buttons: {
			"Add": function() {
				merge=true;
				$( this ).dialog( "close" );
			},
			"Replace": function() {
				merge=false;
				$( this ).dialog( "close" );
			}
		},
		close:function() {
			$('input#file').click();
		}
	});
	//TODO: ergonomize (lol) 'Lists' tab interface so that large amount of rows won't affect accessibility of buttons
	//TODO generalize load and save functions even more to avoid duplicating code
  </script>
  </body>
</html>
